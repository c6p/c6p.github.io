<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="After I have built the site, the next step was checking performance and security. The log, besides being my learning notebook, is also a test-bed for my experiments.


  

  

  
    
    
    
  

  
    
    
    
  




  
  
  Mozilla Observatory security grades"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Demistifying Content Securiy Policy"><meta property="og:description" content="After I have built the site, the next step was checking performance and security. The log, besides being my learning notebook, is also a test-bed for my experiments.


  

  

  
    
    
    
  

  
    
    
    
  




  
  
  Mozilla Observatory security grades"><meta property="og:type" content="article"><meta property="og:url" content="/posts/csp/"><meta property="article:published_time" content="2021-05-09T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-09T00:00:00+00:00"><title>Demistifying Content Securiy Policy | c6p - log</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.3d7f759f287e43e5d79392253c03464daf86ff97c1e7106e3ddd6b9babcc4562.css integrity="sha256-PX91nyh+Q+XXk5IlPANGTa+G/5fB5xBuPd1rm6vMRWI="><script defer src=/en.search.min.24b6f9023a00f4669db221e655de1def173d6dcbd467375a3bba6661b9f9a101.js integrity="sha256-JLb5AjoA9GadsiHmVd4d7xc9bcvUZzdaO7pmYbn5oQE="></script><script integrity="sha256-pVFMSvljJVCh7CR1A+u/EK8kZ5IGzqlyLj0U8ewAvQI=">window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre','code'],renderActions:{addMenu:[]}}};</script><script defer src=https://cdn.jsdelivr.net/npm/mathjax@3.1.4/es5/tex-mml-chtml.js integrity="sha256-ncNI9OXOS5Ek4tzVYiOMmN/KKCPZ6V0Cpv2P/zHntiA=" crossorigin=anonymous></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>c6p - log</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/posts/>Blog</a></li></ul><hr><ul><li><input type=checkbox id=section-7cd66bd2d565ae5bb3c71a81f3ddbfa3 class=toggle>
<label for=section-7cd66bd2d565ae5bb3c71a81f3ddbfa3 class="flex justify-between"><a>Learning</a>
<span>▾</span></label><ul><li><a href=/docs/learning/exercism/>Exercism</a></li><li><a href=/docs/learning/resources/>Resources</a></li></ul></li><li><input type=checkbox id=section-dae2cc4051949457826970813419835e class=toggle>
<label for=section-dae2cc4051949457826970813419835e class="flex justify-between"><a>Course Notes</a>
<span>▾</span></label><ul><li><a href=/docs/courses/operating_systems/>Operating Systems</a></li></ul></li></ul><hr></nav><script integrity="sha256-YOTEaWpzD3vl9uJzu+mnAqXZ6FtydJFha7mYhlhKYU0=">(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg width=24 height=24 class=book-icon alt=Menu></label>
<strong>Demistifying Content Securiy Policy</strong>
<label for=toc-control><img src=/svg/toc.svg width=24 height=24 class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#what-is-csp>What is CSP?</a><ul><li><a href=#why-xss-is-a-problem>Why XSS is a problem?</a></li></ul></li><li><a href=#may-6--github-pages>May 6 — GitHub Pages</a></li><li><a href=#may-8--netlify-a-false-hope>May 8 — Netlify (A false hope)</a><ul><li><a href=#bonus-point>Bonus point</a></li></ul></li><li><a href=#may-9--two-steps-back>May 9 — Two steps back</a></li><li><a href=#may-9---victory>May 9 - Victory</a></li></ul></nav></aside></header><article class=markdown><h1><a href=/posts/csp/>Demistifying Content Securiy Policy</a></h1><div class=post-meta><h5 class=date>May 9, 2021</h5><div class=categories><a href=/categories/configuration/>configuration</a></div><div class=tags><a href=/tags/security/>security</a>
<a href=/tags/web/>web</a></div></div><p><p>After I have built the site, the next step was checking performance and security. The <strong>log</strong>, besides being my learning notebook, is also a test-bed for my experiments.<figure><img src=/attachments/2021-05-09-20-54-11.png srcset="/attachments/2021-05-09-20-54-11.png 688w,/attachments/2021-05-09-20-54-11_hueafe2f74247b181bdf21c2cc42ca8db6_7549_384x0_resize_box_2.png 384w,/attachments/2021-05-09-20-54-11_hueafe2f74247b181bdf21c2cc42ca8db6_7549_192x0_resize_box_2.png 192w" width=688 height=216 alt='<a href="https://observatory.mozilla.org/analyze/c6p.netlify.app">Mozilla Observatory</a> security grades'><figcaption><a href=https://observatory.mozilla.org/analyze/c6p.netlify.app>Mozilla Observatory</a> security grades</figcaption></figure></p><h2 id=what-is-csp>What is CSP?
<a class=anchor href=#what-is-csp>#</a></h2><p>An HTTP header for fine-grained control over where resources are loaded from. By employing content-security-policy, we can eliminate almost all <em>XSS</em> (Cross Site Scripting) attacks.</p><h3 id=why-xss-is-a-problem>Why XSS is a problem?
<a class=anchor href=#why-xss-is-a-problem>#</a></h3><p>arbitrary</p><h2 id=may-6--github-pages>May 6 — GitHub Pages
<a class=anchor href=#may-6--github-pages>#</a></h2><p>GitHub pages does not let us specify HTTP headers, and out of the box the grade is a <strong>D</strong>. One way is to include <code>&lt;meta http-equiv="Content-Security-Policy" content="..."></code> as first child of <code>&lt;head></code>. Yet, netlify lets us set our response headers beyond other goodies, so I skipped ahead.</p><h2 id=may-8--netlify-a-false-hope>May 8 — Netlify (A false hope)
<a class=anchor href=#may-8--netlify-a-false-hope>#</a></h2><p>Setting up a site on netlify from GitHub is trivial. Point to your repository, enter your build command and publish directory. Done.</p><p>Our response headers are in <code>_headers</code> file at the root of publish directory. Mozilla suggest starting with <code>default-src 'none'; img-src 'self'; script-src 'self'; style-src 'self'</code> for CSP.</p><ul><li><code>default-src</code> - default policy for allowed fallback sources<ul><li><code>img-src</code> - for images</li><li><code>font-src</code> - for fonts</li><li><code>script-src</code> - for scripts, i.e. JavaScript</li><li><code>style-src</code> - for styles, i.e. CSS</li><li><code>connect-src</code> - e.g. XMLHttpRequest, WebSocket</li><li><code>object-src</code> - for plugins, e.g. Flash, Silverlight</li></ul></li></ul><p><blockquote class="book-hint info"><ul><li><code>'none'</code> - nothing</li><li><code>'self'</code> - same site</li></ul></blockquote><blockquote class="book-hint warning"><ul><li><code>https:</code> - only HTTPS</li><li><code>'strict-dynamic'</code> - let trusted code blocks to load additional scripts</li></ul></blockquote><blockquote class="book-hint danger"><ul><li><code>'unsafe-hashes'</code> - only code in event handler attributes, e.g. onClick</li><li><code>'unsafe-inline'</code> - all inline code blocks</li><li><code>'unsafe-eval'</code> - eval</li></ul></blockquote></p><p>I began with something similar to what Mozilla suggests, extended to allow CDNs for third party scripts. All <code>&lt;script></code>s required to have a hash or a nonce. A <em>nonce</em> is a cryptographically secure random token <strong>per request</strong> for a script block. It is impossible for a static site to return them. So we should include <code>sha256</code> <em>hash</em>es on <code>integrity</code> attributes (SRI — Sub-resource integrity) to ensure they are not tampered. Simple with Hugo templates.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=color:#75715e>&lt;!-- For inline script blocks --&gt;</span>
{{ with (resources.Get &#34;inline.js&#34; | minify | fingerprint) }}
&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>integrity</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ .Data.Integrity }}&#34;</span>&gt;{{ .<span style=color:#a6e22e>Content</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>safeJS</span> }}&lt;/<span style=color:#f92672>script</span>&gt;
{{ end }}
<span style=color:#75715e>&lt;!-- For external scripts --&gt;</span>
{{ $script := resources.Get &#34;external.js&#34; | minify | fingerprint }}
&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ $script.RelPermalink }}&#34;</span> <span style=color:#a6e22e>integrity</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ $script.Data.Integrity }}&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</code></pre></div><p>Result is an <strong>A+</strong>. Yet, there is a problem. Error log shows that MathJax contains inline scripts and <code>eval</code>s. So we are not yet done.</p><p>Hugo can highlight code blocks (no highlight.js), can preprocess SCSS -via hugo-extended- (no node.js), can minify resources and generate hashes during build. But it can&rsquo;t yet generate diagrams (mermaid.js) nor typeset math (KaTeX, MathJax). Also, a client side search requires JavaScript. Thus, we still need some third party libraries.</p><h3 id=bonus-point>Bonus point
<a class=anchor href=#bonus-point>#</a></h3><p>Though irrelevant to CSP, important for security, for your external links&mldr;
There are some discussions for <code>rel</code> attribute for <code>&lt;base></code> tag for page wide rules.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>target</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;_blank&#34;</span> <span style=color:#a6e22e>rel</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;nofollow noopener noreferrer&#34;</span>&gt;
</code></pre></div><h2 id=may-9--two-steps-back>May 9 — Two steps back
<a class=anchor href=#may-9--two-steps-back>#</a></h2><p>I had to add <code>unsafe-inline</code>s to restore full functionality, although errors about <code>eval</code>s were false flags. <strong>B+</strong>.</p><h2 id=may-9---victory>May 9 - Victory
<a class=anchor href=#may-9---victory>#</a></h2></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#what-is-csp>What is CSP?</a><ul><li><a href=#why-xss-is-a-problem>Why XSS is a problem?</a></li></ul></li><li><a href=#may-6--github-pages>May 6 — GitHub Pages</a></li><li><a href=#may-8--netlify-a-false-hope>May 8 — Netlify (A false hope)</a><ul><li><a href=#bonus-point>Bonus point</a></li></ul></li><li><a href=#may-9--two-steps-back>May 9 — Two steps back</a></li><li><a href=#may-9---victory>May 9 - Victory</a></li></ul></nav></aside></main></body></html>