<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="After I have built the site, the next step was checking performance and security. The log, besides being my learning notebook, is also a test-bed for my experiments.


  

  

  
    
    
    
  

  
    
    
    
  




  
  
  Mozilla Observatory security grades"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Demistifying Content Securiy Policy"><meta property="og:description" content="After I have built the site, the next step was checking performance and security. The log, besides being my learning notebook, is also a test-bed for my experiments.


  

  

  
    
    
    
  

  
    
    
    
  




  
  
  Mozilla Observatory security grades"><meta property="og:type" content="article"><meta property="og:url" content="/posts/csp/"><meta property="article:published_time" content="2021-05-10T20:42:49+00:00"><meta property="article:modified_time" content="2021-05-10T20:42:49+00:00"><title>Demistifying Content Securiy Policy | c6p - log</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.3f1760b7e4086f42d24bc4d1bc639ebcb27994961aedda8d33f8cbd3ade630e3.css integrity="sha256-Pxdgt+QIb0LSS8TRvGOevLJ5lJYa7dqNM/jL063mMOM="><script defer src=/en.search.min.a93dff5fb62f5f3498c18fc2e0508e0c6ff78d97d2a4c63d49eeccf223b3dd86.js integrity="sha256-qT3/X7YvXzSYwY/C4FCODG/3jZfSpMY9Se7M8iOz3YY="></script><script integrity="sha256-pVFMSvljJVCh7CR1A+u/EK8kZ5IGzqlyLj0U8ewAvQI=">window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre','code'],renderActions:{addMenu:[]}}};</script><script defer src=https://cdn.jsdelivr.net/npm/mathjax@3.1.4/es5/tex-mml-chtml.js integrity="sha256-ncNI9OXOS5Ek4tzVYiOMmN/KKCPZ6V0Cpv2P/zHntiA=" crossorigin=anonymous></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>c6p - log</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/posts/>Blog</a></li></ul><hr><ul><li><input type=checkbox id=section-7cd66bd2d565ae5bb3c71a81f3ddbfa3 class=toggle>
<label for=section-7cd66bd2d565ae5bb3c71a81f3ddbfa3 class="flex justify-between"><a>Learning</a>
<span>▾</span></label><ul><li><a href=/docs/learning/exercism/>Exercism</a></li><li><a href=/docs/learning/resources/>Resources</a></li></ul></li><li><input type=checkbox id=section-dae2cc4051949457826970813419835e class=toggle>
<label for=section-dae2cc4051949457826970813419835e class="flex justify-between"><a>Course Notes</a>
<span>▾</span></label><ul><li><a href=/docs/courses/operating_systems/>Operating Systems</a></li></ul></li></ul><hr></nav><script integrity="sha256-YOTEaWpzD3vl9uJzu+mnAqXZ6FtydJFha7mYhlhKYU0=">(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg width=24 height=24 class=book-icon alt=Menu></label>
<label for=toc-control><img src=/svg/toc.svg width=24 height=24 class=book-icon alt="Table of Contents"></label></div></header><article class=markdown><h1><a href=/posts/csp/>Demistifying Content Securiy Policy</a></h1><div class=post-meta><h5 class=date>May 10, 2021</h5><div class=categories><a href=/categories/configuration/>configuration</a></div><div class=tags><a href=/tags/security/>security</a>
<a href=/tags/web/>web</a></div></div><p><p>After I have built the site, the next step was checking performance and security. The <strong>log</strong>, besides being my learning notebook, is also a test-bed for my experiments.<figure><img src=/attachments/2021-05-10-15-24-07.png srcset="/attachments/2021-05-10-15-24-07.png 688w,/attachments/2021-05-10-15-24-07_hueaaa00381f6d19c7c713b5dd39f7731e_3669_384x0_resize_box_2.png 384w,/attachments/2021-05-10-15-24-07_hueaaa00381f6d19c7c713b5dd39f7731e_3669_192x0_resize_box_2.png 192w" width=688 height=265 alt='<a href="https://observatory.mozilla.org/analyze/c6p.netlify.app">Mozilla Observatory</a> security grades'><figcaption><a href=https://observatory.mozilla.org/analyze/c6p.netlify.app>Mozilla Observatory</a> security grades</figcaption></figure></p><h2 id=what-is-csp>What is CSP?
<a class=anchor href=#what-is-csp>#</a></h2><p>An HTTP header for fine-grained control over where resources are loaded from. By employing content-security-policy, we can eliminate <a href=https://csp.withgoogle.com/docs/faq.html#caveats>almost all</a> <em>XSS</em> (Cross Site Scripting) attacks. <a href=https://csp.withgoogle.com/docs/why-csp.html>Read</a> further for why XSS is a problem.</p><h2 id=may-6--github-pages>May 6 — GitHub Pages
<a class=anchor href=#may-6--github-pages>#</a></h2><p><a href=https://pages.github.com/>GitHub pages</a> does not let us specify HTTP headers. One way is to include <code>&lt;meta http-equiv="Content-Security-Policy" content="..."></code> as first child of <code>&lt;head></code>. Yet, netlify lets us set our response headers beyond other goodies, so I skipped ahead. Out of the box the grade is a <strong>D</strong>.</p><h2 id=may-8--netlify-a-false-hope>May 8 — Netlify (A false hope)
<a class=anchor href=#may-8--netlify-a-false-hope>#</a></h2><p>Setting up a site on <a href=https://www.netlify.com/>netlify</a> from GitHub is trivial. Point to your repository, enter your build command and publish directory. Done.</p><p>Our response headers are in <code>_headers</code> file at the root of publish directory. Mozilla suggests starting with <code>default-src 'none'; img-src 'self'; script-src 'self'; style-src 'self'</code> for CSP.</p><ul><li><code>base-uri</code> - restrict URLs for <code>&lt;base></code><table><thead><tr><th style=text-align:right>Directive</th><th style=text-align:left>Feature</th></tr></thead><tbody><tr><td style=text-align:right><code>default-src</code></td><td style=text-align:left>default policy for allowed fallback sources</td></tr><tr><td style=text-align:right><code>img-src</code></td><td style=text-align:left>for images</td></tr><tr><td style=text-align:right><code>font-src</code></td><td style=text-align:left>for fonts</td></tr><tr><td style=text-align:right><code>script-src</code></td><td style=text-align:left>for scripts, i.e. JavaScript</td></tr><tr><td style=text-align:right><code>style-src</code></td><td style=text-align:left>for styles, i.e. CSS</td></tr><tr><td style=text-align:right><code>connect-src</code></td><td style=text-align:left>e.g. XMLHttpRequest, WebSocket</td></tr><tr><td style=text-align:right><code>object-src</code></td><td style=text-align:left>for plugins, e.g. Flash, Silverlight</td></tr></tbody></table></li></ul><p><blockquote class="book-hint info"><ul><li><code>'none'</code> - nothing</li></ul></blockquote><blockquote class="book-hint warning"><ul><li><code>'self'</code> - same site</li><li><code>https://example.com/external.js</code> - specific external resource</li></ul></blockquote><blockquote class="book-hint danger"><ul><li><code>https:</code> - only HTTPS</li><li><code>'unsafe-hashes'</code> - only code in event handler attributes, e.g. onclick</li><li><code>'unsafe-inline'</code> - only inline blocks</li><li><code>'unsafe-eval'</code> - `eval,</li></ul></blockquote></p><p>I began with something like what Mozilla suggests, extended to allow CDNs for third party scripts. All <code>&lt;script></code>s required to have a hash or a nonce. A <em>nonce</em> is a cryptographically secure random token <strong>per request</strong> for a script block. It is impossible for a static site to return them. So we should include <code>sha256</code> <em>hash</em>es on <code>integrity</code> attributes (SRI — Sub-resource integrity) to ensure they are not tampered. Simple with Hugo templates.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=color:#75715e>&lt;!-- For inline script blocks --&gt;</span>
{{ with (resources.Get &#34;inline.js&#34; | minify | fingerprint) }}
&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>integrity</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ .Data.Integrity }}&#34;</span>&gt;{{ .<span style=color:#a6e22e>Content</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>safeJS</span> }}&lt;/<span style=color:#f92672>script</span>&gt;
{{ end }}
<span style=color:#75715e>&lt;!-- For external scripts --&gt;</span>
{{ $script := resources.Get &#34;external.js&#34; | minify | fingerprint }}
&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ $script.RelPermalink }}&#34;</span> <span style=color:#a6e22e>integrity</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ $script.Data.Integrity }}&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</code></pre></div><p>Result is an <strong>A+</strong>. Yet, there is a problem. Error log shows that MathJax contains inline scripts and <code>eval</code>s. So we are not yet done.</p><blockquote class="book-hint info">Hugo can highlight code blocks (no highlight.js), can preprocess SCSS (via hugo-extended, no node.js), can minify resources and generate hashes during build. But it can&rsquo;t yet generate diagrams (mermaid.js) nor typeset math (KaTeX, MathJax). Also, a client side search (FlexSearch in my case) requires JavaScript. Thus, we still need some third party libraries.</blockquote><h2 id=may-9--two-steps-back>May 9 — Two steps back
<a class=anchor href=#may-9--two-steps-back>#</a></h2><p>I had to add <code>unsafe-inline</code>s and domains of CDNs to restore full functionality, although errors about <code>eval</code>s were false flags. <strong>B+</strong>.</p><h2 id=may-10--onward>May 10 — Onward!
<a class=anchor href=#may-10--onward>#</a></h2><p>I learned <code>strict-dynamic</code> and parsed <em>integrity</em> hashes of all inline and external scripts. It worked in Chrome. Sadly caused many problems on <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1409200" title=Bugzilla>Firefox</a>. Following hours of debugging and reading bug reports, I grasped, though it is supported for years, it is unusable. Since <a href=https://www.w3.org/TR/CSP3/>CSP-3</a> being a working draft, <em>hash</em>es for external scripts are unsupported. Still <strong>B+</strong>.<blockquote class="book-hint info"><ul><li><code>'strict-dynamic'</code> - let trusted code blocks to load additional scripts</li></ul></blockquote></p><h3 id=a-bittersweet-victory>A Bittersweet Victory
<a class=anchor href=#a-bittersweet-victory>#</a></h3><p>It seems <a href=https://www.w3.org/TR/CSP2/>CSP-2</a> (current W3C Recommendation) only supports <em>hash</em>es for inline scripts, requiring more fine-grained regexps.</p><p>I created a git pre-commit hook to update hashes whenever I commit my site, in <em>PowerShell</em> being on Windows. Search is using <em>ripgrep</em>, <code>-oIN</code> meaning only print matches without filename or line numbers, and <code>-r</code> to modify result by adding single quotes around it. Unique results filtered and joined on a single line, and written to a file.</p><p>Where first regexp for all integrity strings, second one filters only inline scripts, and third one listing sources of external scripts.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-posh data-lang=posh>hugo --minify
(rg -oIN <span style=color:#e6db74>&#39;&lt;script.*?(sha\d{3}-.{43}=)\&#34;&#39;</span> -r <span style=color:#e6db74>&#39;&#39;&#39;$1&#39;&#39;&#39;</span> public | sort -unique) -join <span style=color:#e6db74>&#39; &#39;</span> | out-file -encoding ASCII -noNewline data/script_hash.txt 
(rg -oIN <span style=color:#e6db74>&#39;&lt;script.*?(sha\d{3}-.{43}=)\&#34;.*?&gt;[^\n&lt;&gt;]+?&lt;/script&gt;&#39;</span> -r <span style=color:#e6db74>&#39;&#39;&#39;$1&#39;&#39;&#39;</span> public | sort -unique) -join <span style=color:#e6db74>&#39; &#39;</span> | out-file -encoding ASCII -noNewline data/inline_script_hash.txt 
(rg -oIN <span style=color:#e6db74>&#39;&lt;script.*?src=\&#34;?(http.*?\.js)[ \&#34;&gt;]&#39;</span> -r <span style=color:#e6db74>&#39;$1&#39;</span> public | sort -unique) -join <span style=color:#e6db74>&#39; &#39;</span> | out-file -encoding ASCII -noNewline data/external_script_source.txt
</code></pre></div><p>Hugo layout template <code>index.headers</code> is used to generate <code>_headers</code>. Here is only the relevant part for <code>script-src</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>script-src {{readFile &#34;data/inline_script_hash.txt&#34;}} &#39;self&#39; {{readFile &#34;data/external_script_source.txt&#34;}};
</code></pre></div><p>And the result is <strong>A+</strong>. Whole content security policy line:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>default-src &#39;none&#39;;
base-uri &#39;self&#39;;
manifest-src &#39;self&#39;;
connect-src &#39;self&#39;;
font-src &#39;self&#39; https://cdn.jsdelivr.net; 
img-src &#39;self&#39; data:;
script-src &#39;sha256-aECzxYUJ57J5H6YymaVqtppSpIqD2Z9YAIAZfd/2xMY=&#39; &#39;sha256-MktN23nRzohmT1JNxPQ0B9CzVW6psOCbvJ20j9YxAxA=&#39; &#39;sha256-OBZ1TAxtlr9xf3a+8VMnoX0v39PPCWCsN6DfNkKio/I=&#39; &#39;self&#39; https://cdn.jsdelivr.net/npm/mathjax@3.1.4/es5/tex-mml-chtml.js https://cdn.jsdelivr.net/npm/mermaid@8.9.3/dist/mermaid.min.js;
style-src &#39;self&#39; &#39;unsafe-inline&#39; https://cdn.jsdelivr.net;
object-src &#39;none&#39;
</code></pre></div><h3 id=further-reading>Further Reading
<a class=anchor href=#further-reading>#</a></h3><ul><li><a href=https://developers.google.com/web/fundamentals/security/csp>Google Developer Documentation</a></li><li><a href=https://content-security-policy.com/>CSP Quick Reference Guide</a></li><li><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP>MDN Web Docs</a></li></ul></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label><label for=toc-control class="hidden book-toc-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#what-is-csp>What is CSP?</a></li><li><a href=#may-6--github-pages>May 6 — GitHub Pages</a></li><li><a href=#may-8--netlify-a-false-hope>May 8 — Netlify (A false hope)</a></li><li><a href=#may-9--two-steps-back>May 9 — Two steps back</a></li><li><a href=#may-10--onward>May 10 — Onward!</a><ul><li><a href=#a-bittersweet-victory>A Bittersweet Victory</a></li><li><a href=#further-reading>Further Reading</a></li></ul></li></ul></nav></aside></main></body></html>